# Библиотека

Решение
[вот этого](https://docs.google.com/document/d/1ej6Qdhf65VP6d8rPCti2wdiD680p91UKu6GQS7i-IKs/edit?pli=1&tab=t.0)
задания

### Структура:

Код приложения в папке [_src/_](src) .  
В [_core/_](src/core) -- общие файлы проекта:
интерфейсы,
абстрактные классы,
схемы данных,
настройки инфраструктуры,
файл конфигурации
и т. д.

Файл безопасности с генератором токенов и хешированием вот [тут](src/core/security.py)

В папке [_services_](src/services) модули управления конкретными сущностями (readers, books . . ).

###### Подробнее о схеме данных

Написана на _sqlalchemy core_ (бeз ORM. Автор любит контролировать все что происходит с БД).  
Многие проверки производятся преимущественно на стороне БД  
ради уменьшения сетевых издержек (можно оптимизировать еще больше и сделать все проверки на стороне БД по типу 1 запрос
в API = 1 запрос в базу, как я обычно делаю, но не думаю что у тестового проекта будет большая нагрузка :) )  
Структура таблиц максимально прямолинейная и логично нормализованная. Находится по адресу  
[src/core/schemas.py](src/core/schemas.py) с описанием всех таблиц.  
Все запросы построены так, чтобы сразу получить готовый для выдачи ответ (без всяких там ORM сериализаторов - JSON
собирается прям в БД)

###### Содержимое сервисов (В папке [_services_](src/services)):

* _routes.py_ с описанием конечных точек
* _services.py_ - набор классов обработчиков запроса
* _repositories.py_ - набор классов с операциями над БД
* _exc.py_ - набор пользовательских ошибок
* _dto/_ - набор моделей входных и выходных данных

В файле _app.py_ - основная инициализация зависимостей, подключение роутеров.  
[_main.py_](main.py) (на одном уровне с _src/_) - файл запускатор.

Все операции обернуты в классы (и сервисы и репозитории) для более тонкой настройки и инкапсуляции внутренней логики.

* роутеры (*routes.py*)
  принимают запрос,
  содержат документацию для **OpenAPI**,
  подключают необходимые зависимости
  (в данном проекте по факту только одна зависимость - авторизационный токен),
  валидируют входные данные описанные в `dto/input.py` (если это тело запроса)


* сервисы (*service.py*)
  принимают проверенные данные с роутера,
  подключают дальнейшие зависимости (в данном проекте только зависимости от БД)
  вызывают операцию базы данных


* репозитории (*repository.py*)
  выполняют логику на стороне БД,
  возвращают модель результата (если он подразумевается) описанного в `dto/output.py`.
  Если во время работы приложения база данных вдруг откиснет, ошибку отловит волшебный класс
  `FailedConnectionDBMeta` (находится вот [тут](src/core/interfaces.py) волшебным декоратором `catch`
  (а он вот [тут](src/core/utils.py)

###### Логика

пункты ***4.1***, ***4.2***, ***4.3*** -
Модуль [borrowed_books/repository.py](src/services/borrowed_books/repository.py)
все операции подробно документированы.

Функции просмотра списка книг или конкретного экземпляра публичные.
Читатель теоретически может сначала посмотреть (и выбрать книгу) например в терминале библиотеки
чтобы ее потом взять.

### Запуск

Отредактируйте файл [_.env_](.env) под собственные нужды если необходимо (стандартные настройки в корне проекта).  
Выполните команду ```docker compose up``` из корня проекта.

После успешного запуска (приглашение в консоли вроде такого ```INFO   Uvicorn running on http://localhost:10000```)  
перейдите по адресу http://localhost:10000/docs (или теми настройками которые вы указали в _.env_)
для просмотра OpenAPI документации.  
В документации есть краткое описание ручек со схемами ввода вывода (кроме ошибок, это было бы сильно дольше).

### Примечания

Автор сей поделки не работает с alembic (он очень любит Enum'ы, а alembic Enum'ы не любит)
и накатывает миграции руками (прям оборачивает сырой sql в файлы и ставит на них даты, да),
но раз уж вы настаиваете их можно посмотреть вот в папке [alembic/versions](alembic/versions).
Если что-то не правильно сильно не пинайте, автор не знаком с инструментом.

Автор сей поделки не умеет писать автотесты! Вообще! Абсолютно! Не понимает как строятся проекты тестирования приложений
и тестирует все руками (ну или крайний случай пишет кастомные клиенты с цепочками сценариев (например для websockets))
и обязательно посмотрит как это делается правильно, но не сейчас (иначе выйду за дедлайн),
но раз уж вы настаиваете :) . . . Файл [test_cases.py](tests/test_cases.py) - 210 строк отборнейшего ~~говно~~кода  :)
тестирует то что требует ТЗ и даже немножко больше (не все разумеется). Описания "тестов" прилагаются.
Паттерн "Always repeat yourself" во всей его красе. Будем считать что это шутка такая :), но вручную все
протестировано (
ну почти все)

### Отказ от ответственности

Автор не поднимает отдельные тестовые контейнеры с БД (это демонстрационный проект) и написанные им "тесты"
обязательно снесут все данные при перезапуске (это легко исправляется если нужно).

### P.S. странное поведение

После поднятия контейнеров и открытия OpenAPI
первый запрос в базу выдаст ошибку подключения. Почему?
Понятия не имею! Без контейнеров на стационарной базе и колдовства с alembic такого поведения нет. Последующие запросы
идут как положено.


